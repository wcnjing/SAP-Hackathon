<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="static\css\style.css" />
<title>SAP-style Chat UI + Sessions</title>
</head>

<body>
  <div class="frame" id="frame">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <button class="hamburger" id="toggle" title="Collapse/Expand">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>

        <img src="/chatbot/images/saplogo.png" alt="Brand" class="brand-logo">
      </div>

      <!-- NEW CHAT BUTTON -->
      <button class="newchat" id="newChatBtn" title="Start a new chat">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        <span class="text-hide">New Chat</span>
      </button>

      <div class="section-title">History</div>
      <div class="history" id="historyList"></div>

      <div class="settings" title="Settings">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
          <path d="M19.4 15a1.7 1.7 0 0 0 .34 1.88l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.7 1.7 0 0 0 15 19.4a1.7 1.7 0 0 0-1 .6l-.06.06a2 2 0 1 1-3 0l-.06-.06a1.7 1.7 0 0 0-1-.6 1.7 1.7 0 0 0-1.88-.34l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.7 1.7 0 0 0 4.6 15a1.7 1.7 0 0 0-.6-1l-.06-.06a2 2 0 1 1 0-3l.06-.06a1.7 1.7 0 0 0 .6-1 1.7 1.7 0 0 0-.34-1.88l-.06-.06A2 2 0 1 1 6.93 3.1l.06.06A1.7 1.7 0 0 0 8 3.6a1.7 1.7 0 0 0 1-.6l.06-.06a2 2 0 1 1 3 0l.06.06a1.7 1.7 0 0 0 1 .6 1.7 1.7 0 0 0 1.88.34l.06-.06A2 2 0 1 1 20.9 6.93l-.06.06a1.7 1.7 0 0 0-.6 1 1.7 1.7 0 0 0 .34 1.88l.06.06a2 2 0 1 1 0 3l-.06.06a1.7 1.7 0 0 0-.6 1Z"/>
        </svg>
        <span class="text-hide">Settings</span>
      </div>
    </aside>

    <!-- Chat -->
    <main class="chat">
      
      <div class="messages" id="messages"></div>

      <div class="composer">
        <div class="inner">
          <button class="iconbtn" title="Attach">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15.5V7a5 5 0 0 0-10 0v10a3 3 0 1 0 6 0V8"/>
            </svg>
          </button>

          <div class="input">
            <textarea id="input" placeholder="Ask me anything"></textarea>
          </div>

          <button class="iconbtn send" id="send" title="Send (Enter)">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13"/>
              <path d="M22 2l-7 20-4-9-9-4 20-7Z"/>
            </svg>
          </button>
        </div>
      </div>
    </main>
  </div>

<script>
  // ---------- Utilities ----------
  const $ = (sel, el = document) => el.querySelector(sel);
  const $$ = (sel, el = document) => [...el.querySelectorAll(sel)];
  const escapeHtml = (s = '') => s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2) + Date.now()));
  const composerEl = document.querySelector('.composer');

  // ---------- Storage ----------
  const STORAGE_KEY = 'chat_sessions_v1';
  const loadSessions = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const saveSessions = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));

  // ---------- State ----------
  let sessions = loadSessions();
  let currentId = null;

  // Seed first session on first load
  if (sessions.length === 0) {
    const id = uuid();
    sessions = [{
      id,
      title: 'Welcome',
      createdAt: Date.now(),
      updatedAt: Date.now(),
      messages: [
        { role: 'ai',  text: 'Hello! Ask me anything. This mock UI includes a collapsible sidebar, a scrollable chat canvas, and a composer dock below.' },
        { role: 'you', text: 'How do I download Python?' },
        { role: 'ai',  text: 'Visit python.org → Downloads, grab the installer for your OS, then follow the prompts (on Windows, tick “Add python.exe to PATH”).' }
      ]
    }];
    currentId = id;
    saveSessions(sessions);
  } else {
    currentId = sessions[0].id;
  }

  // ---------- Rendering ----------
  const messagesEl = $('#messages');
  const historyEl  = $('#historyList');

  function getSnippet(session){
    const last = session.messages[session.messages.length - 1];
    return last ? (last.text || '').replace(/\s+/g, ' ').slice(0, 80) : '';
  }

  function renderHistory(){
    historyEl.innerHTML = '';
    sessions.forEach((s, i) => {
        const row = document.createElement('div');
        row.className = 'item' + (s.id === currentId ? ' active' : '');
        row.setAttribute('role', 'button');
        row.setAttribute('tabindex', '0');
        row.innerHTML = `
        <div class="title">${escapeHtml(s.title)}</div>
        <div class="sub">${escapeHtml(getSnippet(s))}</div>
        <button class="del" title="Delete chat" aria-label="Delete chat">
            <svg viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
            <path d="M3 6h18"/>
            <path d="M8 6v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
            <path d="M10 11v6M14 11v6"/>
            </svg>
        </button>
        `;

        // open chat
        row.addEventListener('click', () => {
        currentId = s.id;
        renderHistory();
        renderMessages();
        });

        // keyboard open
        row.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            row.click();
        }
        });

        // delete (stop row click)
        row.querySelector('.del').addEventListener('click', (e) => {
        e.stopPropagation();
        deleteChat(s.id);
        });

        historyEl.appendChild(row);
    });
    }


  function renderMessages(){
    messagesEl.innerHTML = '';
    const s = sessions.find(x => x.id === currentId);
    if (!s) return;
    s.messages.forEach(m => appendBubble(m.role === 'you' ? 'You' : 'AI', m.text));
    scrollToBottom();
  }

  function appendBubble(role, text){
    const div = document.createElement('div');
    div.className = 'bubble' + (role === 'You' ? ' user' : '');
    div.innerHTML = `<div class="meta"><span class="role">${role}</span></div><div>${escapeHtml(text).replace(/\n/g,'<br/>')}</div>`;
    messagesEl.appendChild(div);
  }

  function scrollToBottom(){
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ---------- Composer / Sending ----------
  const ta = $('#input');
  const sendBtn = $('#send');

  function autogrow(el){
    el.style.height = '28px';
    el.style.height = Math.min(el.scrollHeight, 140) + 'px';
  }

  function addTyping(){
    const d = document.createElement('div');
    d.className = 'bubble';
    d.dataset.typing = '1';
    d.innerHTML = `<div class="meta"><span class="role">AI</span></div><div>Typing…</div>`;
    messagesEl.appendChild(d);
    scrollToBottom();
    return d;
  }

  async function callChatAPI(message){
    // Change URL if your backend runs on a different origin/port:
    // e.g. 'http://localhost:3000/api/chat'
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message,
        sessionId: currentId     // handy to keep server sessions
      })
    });

    if (!res.ok) {
      // backends often return text on error — surface it
      const errText = await res.text().catch(() => res.statusText);
      throw new Error(errText || `HTTP ${res.status}`);
    }

    // support both text and JSON responses
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      const data = await res.json();
      // expect { reply: "..." } — adjust the key if your API differs
      return data.reply ?? JSON.stringify(data);
    }
    return await res.text();
  }


  async function send(){
    const text = ta.value.trim();
    if (!text) return;

    // find current session
    const s = sessions.find(x => x.id === currentId);
    if (!s) return;

    // add user's message
    s.messages.push({ role: 'you', text });
    if (s.title === 'New Chat' || s.title === 'Welcome') {
      s.title = text.slice(0, 28);
    }
    s.updatedAt = Date.now();
    saveSessions(sessions);

    // update UI
    appendBubble('You', text);
    ta.value = '';
    autogrow(ta);
    renderHistory();
    updateLayoutAndKeepBottom();

    // show typing indicator
    const typing = addTyping();

    try {
      // ---- REAL BACKEND CALL ----
      const reply = await callChatAPI(text);

      typing.remove();
      s.messages.push({ role: 'ai', text: reply });
      s.updatedAt = Date.now();
      saveSessions(sessions);
      appendBubble('AI', reply);
      renderHistory();
      updateLayoutAndKeepBottom();
    } catch (err) {
      typing.remove();
      appendBubble('AI', `⚠️ Backend error: ${err.message || String(err)}`);
      updateLayoutAndKeepBottom();
    }
  }


  sendBtn.addEventListener('click', send);
  ta.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // ---------- New chat ----------
  $('#newChatBtn').addEventListener('click', () => {
    const id = uuid();
    sessions.unshift({
      id,
      title: 'New Chat',
      createdAt: Date.now(),
      updatedAt: Date.now(),
      messages: []
    });
    currentId = id;
    saveSessions(sessions);
    renderHistory();
    messagesEl.innerHTML = '';
    ta.focus();
  });

  function deleteChat(id){
    const idx = sessions.findIndex(s => s.id === id);
    if (idx === -1) return;

    if (!confirm('Delete this chat? This cannot be undone.')) {
        return;
    }

    // Choose the next chat to show if we're deleting the current one
    let nextId = currentId;
    if (currentId === id) {
        if (sessions[idx + 1]) {
        nextId = sessions[idx + 1].id;
        } else if (sessions[idx - 1]) {
        nextId = sessions[idx - 1].id;
        } else {
        nextId = null;
        }
    }

    // Remove it
    sessions.splice(idx, 1);

    // If nothing left, create a fresh empty chat
    if (sessions.length === 0) {
        const idNew = uuid();
        sessions = [{
        id: idNew,
        title: 'New Chat',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        messages: []
        }];
        nextId = idNew;
    }

    currentId = nextId;
    saveSessions(sessions);
    renderHistory();
    renderMessages();
    }

    function updateComposerPadding(){
      // read current composer height and push into the CSS var
      const h = composerEl.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--composer-h', `${h}px`);
    }

    function updateLayoutAndKeepBottom(){
      updateComposerPadding();
      // keep the view pinned to bottom when things change
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }



      // ---------- Collapse toggle ----------
      $('#toggle').addEventListener('click', () => {
        $('#frame').classList.toggle('compact');
      });

  // Initial render
  renderHistory();
  renderMessages();
  updateLayoutAndKeepBottom();

  // when the textarea grows
  ta.addEventListener('input', () => {
    autogrow(ta);
    updateLayoutAndKeepBottom();
  });


  // when window size or zoom changes
  window.addEventListener('resize', updateLayoutAndKeepBottom);

  // if you toggle the sidebar width
  document.getElementById('toggle').addEventListener('click', () => {
    document.getElementById('frame').classList.toggle('compact');
    requestAnimationFrame(updateLayoutAndKeepBottom);
  });
</script>
</body>
</html>

